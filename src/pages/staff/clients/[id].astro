---
import Layout from "../../../layouts/Layout.astro";
import { CLIENT_RECORDS } from "../../../data/staff-data";
import "../../../styles/calendar.css";

const { id } = Astro.params;
const client = CLIENT_RECORDS.find((c) => c.id === id);

if (!client) {
    return Astro.redirect("/staff/clients");
}

// Sort treatment history by date (most recent first)
const sortedHistory = [...client.treatmentHistory].sort(
    (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime(),
);
---

<Layout title={`Client Record - ${client.name}`}>
    <main class="page-content">
        <section class="section">
            <div class="container">
                <!-- Breadcrumb -->
                <div style="margin-bottom: 2rem;">
                    <a
                        href="/staff/dashboard"
                        style="color: rgba(255, 255, 255, 0.6); text-decoration: none;"
                    >
                        ← Back to Dashboard
                    </a>
                </div>

                <!-- Client Header -->
                <div
                    class="client-header"
                    style="display: flex; gap: 2rem; margin-bottom: 3rem; align-items: start;"
                >
                    <div
                        class="client-avatar"
                        style="width: 80px; height: 80px; font-size: 2rem;"
                    >
                        {
                            client.name
                                .split(" ")
                                .map((n) => n[0])
                                .join("")
                        }
                    </div>

                    <div style="flex: 1;">
                        <h1>{client.name}</h1>
                        <div
                            style="display: flex; gap: 2rem; margin-top: 1rem; color: rgba(255, 255, 255, 0.7);"
                        >
                            <div>
                                <strong>Email:</strong>
                                {client.email}
                            </div>
                            <div>
                                <strong>Phone:</strong>
                                {client.phone}
                            </div>
                            <div>
                                <strong>Client since:</strong>
                                {
                                    new Date(
                                        client.clientSince,
                                    ).toLocaleDateString("en-GB")
                                }
                            </div>
                            <div>
                                <strong>Last visit:</strong>
                                {
                                    new Date(
                                        client.lastVisit,
                                    ).toLocaleDateString("en-GB")
                                }
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary">Book Appointment</button>
                </div>

                <!-- Client Details Grid -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;"
                >
                    <!-- Consultation Notes -->
                    <div class="info-card">
                        <h3
                            style="margin-bottom: 1rem; color: var(--color-accent);"
                        >
                            Consultation Notes
                        </h3>
                        <p
                            style="line-height: 1.6; color: rgba(255, 255, 255, 0.8);"
                        >
                            {client.consultationNotes}
                        </p>
                        <button
                            class="btn btn-outline"
                            style="margin-top: 1rem; width: 100%;"
                        >
                            Edit Notes
                        </button>
                    </div>

                    <!-- Preferences -->
                    <div class="info-card">
                        <h3
                            style="margin-bottom: 1rem; color: var(--color-accent);"
                        >
                            Preferences
                        </h3>
                        <ul
                            style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.5rem;"
                        >
                            {
                                client.preferences.map((pref) => (
                                    <li style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--color-accent);">
                                            ✓
                                        </span>
                                        <span>{pref}</span>
                                    </li>
                                ))
                            }
                        </ul>
                    </div>

                    <!-- Allergies/Contraindications -->
                    <div class="info-card">
                        <h3 style="margin-bottom: 1rem; color: #ff6b6b;">
                            ⚠️ Allergies & Notes
                        </h3>
                        {
                            client.allergies.length > 0 ? (
                                <ul style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: 0.5rem;">
                                    {client.allergies.map((allergy) => (
                                        <li style="display: flex; align-items: center; gap: 0.5rem; color: #ff6b6b;">
                                            <span>⚠️</span>
                                            <span>
                                                <strong>{allergy}</strong>
                                            </span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p style="color: rgba(255, 255, 255, 0.6);">
                                    No allergies recorded
                                </p>
                            )
                        }
                    </div>
                </div>

                <!-- Treatment History -->
                <div>
                    <h2 style="margin-bottom: 1.5rem;">Treatment History</h2>

                    <div class="treatment-timeline">
                        {
                            sortedHistory.map((treatment, index) => (
                                <div class="treatment-record">
                                    <div class="treatment-date">
                                        <div class="date-badge">
                                            {new Date(
                                                treatment.date,
                                            ).toLocaleDateString("en-GB", {
                                                day: "numeric",
                                                month: "short",
                                                year: "numeric",
                                            })}
                                        </div>
                                    </div>

                                    <div class="treatment-content">
                                        <div class="treatment-header">
                                            <h3>{treatment.treatment}</h3>
                                            <div class="treatment-meta">
                                                <span>
                                                    {treatment.staffName}
                                                </span>
                                                <span>•</span>
                                                <span>
                                                    {treatment.duration} mins
                                                </span>
                                                <span>•</span>
                                                <span>£{treatment.price}</span>
                                            </div>
                                        </div>

                                        {treatment.notes && (
                                            <div class="treatment-notes">
                                                <strong>Notes:</strong>{" "}
                                                {treatment.notes}
                                            </div>
                                        )}

                                        {treatment.productsUsed.length > 0 && (
                                            <div class="products-used">
                                                <strong>Products:</strong>
                                                <div class="product-tags">
                                                    {treatment.productsUsed.map(
                                                        (product) => (
                                                            <span class="product-tag">
                                                                {product}
                                                            </span>
                                                        ),
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))
                        }
                    </div>

                    {
                        sortedHistory.length === 0 && (
                            <p style="text-align: center; color: rgba(255, 255, 255, 0.6); padding: 3rem;">
                                No treatment history yet
                            </p>
                        )
                    }
                </div>
            </div>
        </section>
    </main>
</Layout>

<style>
    .info-card {
        background: var(--color-surface);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .treatment-timeline {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .treatment-record {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 2rem;
        padding: 1.5rem;
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
    }

    .treatment-record:hover {
        border-color: var(--color-accent);
        transform: translateX(4px);
    }

    .date-badge {
        background: linear-gradient(135deg, var(--color-accent), #c9a143);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        text-align: center;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .treatment-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .treatment-header h3 {
        margin: 0 0 0.5rem;
        font-size: 1.25rem;
    }

    .treatment-meta {
        display: flex;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .treatment-notes {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-sm);
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.9);
    }

    .products-used {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .product-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .product-tag {
        background: rgba(212, 175, 55, 0.15);
        color: var(--color-accent);
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        border: 1px solid rgba(212, 175, 55, 0.3);
    }

    @media (max-width: 768px) {
        .treatment-record {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .client-header {
            flex-direction: column;
        }
    }
</style>
